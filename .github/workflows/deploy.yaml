name: CI/CD to EC2 (K8s, SHA tagging)

on:
  push:
    branches:
      - master   # change to 'main' if your default branch is main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3) Build Docker image from repo root context (.)
      #    Detect Dockerfile name (Dockerfile or dockerfile) at repo root.
      - name: Build Docker image (SHA + latest)
        id: build
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${{ secrets.DOCKER_REPO }}" ]]; then
            echo "ERROR: secrets.DOCKER_REPO is not set (e.g., 'sahana/demo-app2')"
            exit 1
          fi
          if [[ "${{ secrets.DOCKER_REPO }}" == *"*"* ]]; then
            echo "ERROR: secrets.DOCKER_REPO contains invalid '*'. Use e.g., 'sahana/demo-app2'."
            exit 1
          fi

          # Detect Dockerfile at repo root (case-sensitive)
          DOCKERFILE=""
          if [[ -f "Dockerfile" ]]; then
            DOCKERFILE="Dockerfile"
          elif [[ -f "dockerfile" ]]; then
            DOCKERFILE="dockerfile"
          else
            echo "ERROR: No Dockerfile found at repo root. Place it at ./Dockerfile or ./dockerfile"
            echo "Repo root files:"
            ls -la
            exit 1
          fi

          echo "Using Dockerfile: $DOCKERFILE"
          echo "Using build context: . (repo root)"

